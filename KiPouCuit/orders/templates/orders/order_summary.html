{% extends 'base.html' %}
{% load static %}

{% block title %}Order Summary{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'orders/order_summary.css' %}">

<div class="order-summary-container center">
  <h1>Order Summary</h1>

  <section class="order-items">
    {% if items %}
    {% for item in items %}
    <div class="order-item">
      <img src="{{ item.image }}" alt="{{ item.name }}">
      <div class="item-details">
        <h4>{{ item.name }}</h4>
      </div>
      <div class="item-price">Rs {{ item.price|floatformat:0 }}</div>

      <!-- Quantity controls -->
      <div class="item-qty">
        <form action="{% url 'update_quantity' item.id %}" method="post" style="display:inline;">
          {% csrf_token %}
          <input type="hidden" name="action" value="dec">
          <button type="submit" class="qty-btn">‚àí</button>
        </form>

        <span class="qty-count">{{ item.quantity }}</span>

        <form action="{% url 'update_quantity' item.id %}" method="post" style="display:inline;">
          {% csrf_token %}
          <input type="hidden" name="action" value="inc">
          <button type="submit" class="qty-btn">+</button>
        </form>
      </div>

      <!-- Remove button -->
      <div class="item-actions">
        <form action="{% url 'remove_from_order' item.id %}" method="post">
          {% csrf_token %}
          <button type="submit" class="remove-btn">Remove</button>
        </form>
      </div>
    </div>
    {% endfor %}
    {% else %}
    <div class="empty-cart-container">
      <div class="empty-cart-icon">
        üõí
      </div>
      <h2 class="empty-cart-title">Your Cart is Empty</h2>
      <p class="empty-cart-message">Looks like you haven't added any delicious meals yet!</p>
      <a href="{% url 'menu' %}" class="back-to-menu-btn">
        <span class="btn-icon">üçΩÔ∏è</span>
        Explore Our Menu
      </a>
    </div>
    {% endif %}
  </section>

  <!-- Summary Sidebar -->
  <div class="summary-box">
    <div class="sum-left">
      <h2>Summary</h2>
      {% for item in items %}
      <p>{{ item.quantity }} √ó Rs {{ item.price|floatformat:0 }}</p>
      {% endfor %}
    </div>

    <div class="sum-right">
      <h2>Total: Rs {{ total|floatformat:0 }}</h2>
      {% if items %}
      <a class="checkout-btn" href="{% url 'checkout' %}">Pay and Checkout</a>
      {% endif %}
    </div>
  </div>
</div>

<script>
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  // Store the current cart state on page load
  let currentCartState = null;

  function fetchCartState() {
    return fetch('/cart/data/', {
      headers: {
        'X-Requested-With': 'XMLHttpRequest',
      }
    })
      .then(r => r.json())
      .then(data => {
        return JSON.stringify(data.cart_items);
      });
  }

  // Poll for cart changes every 2 seconds
  function checkForCartChanges() {
    fetchCartState().then(newState => {
      if (currentCartState === null) {
        currentCartState = newState;
      } else if (currentCartState !== newState) {
        // Cart has changed, reload the page
        window.location.reload();
      }
    });
  }

  // Start polling when page loads
  document.addEventListener('DOMContentLoaded', function () {
    fetchCartState().then(state => {
      currentCartState = state;
    });

    // Check every 2 seconds
    setInterval(checkForCartChanges, 2000);
  });

  // Handle remove button clicks
  document.addEventListener('submit', function (e) {
    const form = e.target;

    // Check if this is a remove form
    if (form.action.includes('/remove_from_order/')) {
      e.preventDefault();

      const match = form.action.match(/\/remove_from_order\/(\d+)\//);
      if (!match) return;

      const itemId = match[1];

      fetch(form.action, {
        method: 'POST',
        headers: {
          'X-Requested-With': 'XMLHttpRequest',
          'X-CSRFToken': getCookie('csrftoken'),
        },
        body: new FormData(form)
      })
        .then(r => r.json())
        .then(data => {
          if (data.success) {
            window.location.reload();
          }
        })
        .catch(err => {
          console.error('Error removing item:', err);
          window.location.reload();
        });
    }

    // Handle quantity updates
    if (form.action.includes('/update_quantity/')) {
      e.preventDefault();

      const match = form.action.match(/\/update_quantity\/(\d+)\//);
      if (!match) return;

      const itemId = match[1];
      const action = form.querySelector('input[name="action"]').value;

      fetch(form.action, {
        method: 'POST',
        headers: {
          'X-Requested-With': 'XMLHttpRequest',
          'X-CSRFToken': getCookie('csrftoken'),
        },
        body: new FormData(form)
      })
        .then(r => r.json())
        .then(data => {
          if (data.success) {
            window.location.reload();
          }
        })
        .catch(err => {
          console.error('Error updating quantity:', err);
          window.location.reload();
        });
    }
  });

  // Update cart badge if it exists
  function updateCartBadge() {
    fetch('/cart/data/', {
      headers: {
        'X-Requested-With': 'XMLHttpRequest',
      }
    })
      .then(r => r.json())
      .then(data => {
        const countEl = document.querySelector('.cart-count');
        if (countEl) {
          countEl.textContent = data.cart_count || 0;
        }
      })
      .catch(console.error);
  }

  // Update cart badge on page load
  document.addEventListener('DOMContentLoaded', updateCartBadge);
</script>
{% endblock %}