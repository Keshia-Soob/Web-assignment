{% extends 'base.html' %}
{% load static %}

{% block title %}Menu{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'meals/MenuStyle.css' %}">

{% url 'add_to_cart' 0 as ADD_TO_CART_BASE %}

<div class="menu-container">
  <div class="menu-title">
    <h1>Our Delicious Menu</h1>
    <p>Explore our wide variety of mouth-watering dishes</p>
  </div>

  <!-- Search + Filter Controls -->
  <div class="menu-controls">

    <!--SEARCH BAR -->
    <input type="text" id="searchInput" placeholder="Search by meal or cuisine...">

    <!-- Cuisine filter -->
    <div class="cuisine-selector">
      <select id="cuisineFilter">
        <option value="all">All Cuisines</option>
        <option value="indian">Indian</option>
        <option value="mauritian">Mauritian</option>
        <option value="english">English</option>
        <option value="french">French</option>
        <option value="asian">Asian</option>
      </select>
    </div>
  </div>

  <!-- Global "no results" message -->
  <p id="noResultsMessage" style="display:none; text-align:center; font-weight:bold; margin-top:20px;">
    No meals found.
  </p>

  {% if menu_by_cuisine %}
  {% for cuisine, items in menu_by_cuisine.items %}
  <div class="cuisine-section" data-cuisine="{{ cuisine|lower }}">

    <div class="cuisine-title">
      <h2>{{ cuisine|title }}</h2>
    </div>

    <div class="food-grid">
      {% for item in items %}
      <div class="food-item"
        data-cuisine="{{ item.cuisine|lower }}"
        data-name="{{ item.name|lower }}"
        data-id="{{ item.id }}"
        data-price="{{ item.price|floatformat:0 }}">
        
        <div class="food-image" style="background-image: url('{{ item.display_image_url }}');"></div>
        
        <div class="food-details">
          <h3 class="food-name">{{ item.name }}</h3>
          <p class="food-description">{{ item.description }}</p>

          <div class="food-footer">
            <span class="food-price">Rs {{ item.price|floatformat:0 }}</span>

            <form class="add-to-cart-form" data-id="{{ item.id }}">
              {% csrf_token %}
              <button type="submit" class="add-btn">Add</button>
            </form>

          </div>
        </div>
      </div>
      {% empty %}
      <p>No items in this cuisine yet.</p>
      {% endfor %}
    </div>

    <!-- Cuisine-level "no match" -->
    <p class="no-cuisine-results" style="display:none; font-weight:bold;">
      No meals found in this cuisine.
    </p>

  </div>
  {% endfor %}
  {% endif %}
</div>

<!-- Toast container -->
<div id="toast-container"></div>


<script>

  // SEARCH BAR + CUISINE FILTER
  
  document.addEventListener("DOMContentLoaded", function () {
    const searchInput = document.getElementById("searchInput");
    const cuisineFilter = document.getElementById("cuisineFilter");
    const sections = document.querySelectorAll(".cuisine-section");
    const noResultsMessage = document.getElementById("noResultsMessage");

    function applyFilters() {
      const search = searchInput.value.toLowerCase();
      const cuisineVal = cuisineFilter.value;

      let globalMatchFound = false;

      sections.forEach(section => {
        const sectionCuisine = section.dataset.cuisine;
        const items = section.querySelectorAll(".food-item");
        const cuisineNoMatchMsg = section.querySelector(".no-cuisine-results");

        let cuisineHasMatch = false;

        items.forEach(item => {
          const name = item.dataset.name;
          const cuisine = item.dataset.cuisine;

          const matchesSearch =
            name.includes(search) ||
            cuisine.includes(search);

          const matchesCuisine =
            (cuisineVal === "all" || cuisineVal === sectionCuisine);

          const show = matchesSearch && matchesCuisine;

          item.style.display = show ? "" : "";

          if (show) {
            item.style.display = "";
            cuisineHasMatch = true;
            globalMatchFound = true;
          } else {
            item.style.display = "none";
          }
        });

        // show/hide "no meals found in cuisine"
        cuisineNoMatchMsg.style.display = cuisineHasMatch ? "none" : "block";

        // show/hide entire section
        section.style.display = cuisineHasMatch ? "" : "none";
      });

      // GLOBAL "no results"
      noResultsMessage.style.display = globalMatchFound ? "none" : "block";
    }

    searchInput.addEventListener("input", applyFilters);
    cuisineFilter.addEventListener("change", applyFilters);
    applyFilters();
  });

  //ADD TO CART + CART SCRIPTS

  document.addEventListener("submit", function (e) {
    if (!e.target.matches(".add-to-cart-form")) return;
    e.preventDefault();

    const form = e.target;
    const id = form.dataset.id;

    const base = "{{ ADD_TO_CART_BASE }}";
    const url = base.replace("/0/", `/${id}/`);
    const btn = form.querySelector('button[type="submit"]');
    btn.disabled = true;

    fetch(url, {
      method: "POST",
      headers: {
        "X-Requested-With": "XMLHttpRequest",
        "X-CSRFToken": getCookie("csrftoken"),
      },
      body: new FormData(form),
    })
      .then(r => r.json())
      .then(data => {
        const countEl = document.querySelector(".cart-count");
        if (countEl && typeof data.cart_count !== "undefined") {
          countEl.textContent = data.cart_count;
        }
        updateCartDropdown();
        showAddToCartFeedback(form.closest(".food-item")?.dataset.name || "Item");
      })
      .catch(console.error)
      .finally(() => { btn.disabled = false; });
  });

  function updateCartDropdown() {
    fetch('/cart/data/', {
      headers: { "X-Requested-With": "XMLHttpRequest" }
    })
      .then(r => r.json())
      .then(data => {
        const countEl = document.querySelector(".cart-count");
        if (countEl) countEl.textContent = data.cart_count || 0;

        const subtotalEl = document.getElementById("cartSubtotal");
        if (subtotalEl) subtotalEl.textContent = `Rs ${data.cart_subtotal.toFixed(0)}`;

        const container = document.getElementById("cartItemsContainer");
        if (!container) return;

        if (!data.cart_items || Object.keys(data.cart_items).length === 0) {
          container.innerHTML = `
            <div class="cart-item">
              <div class="item-details">
                <div class="item-name">Your cart is empty</div>
                <div class="item-quantity">Add items to see them here</div>
              </div>
            </div>`;
          return;
        }

        let html = '';
        for (const [itemId, item] of Object.entries(data.cart_items)) {
          html += `
            <div class="cart-item">
              <div class="item-details">
                <div class="item-name">${item.name}</div>
                <div class="item-quantity">Qty: ${item.quantity}</div>
                <div class="item-price">Rs ${item.price} x ${item.quantity}</div>
              </div>
              <button class="remove-item-btn" data-item-id="${itemId}">Remove</button>
            </div>`;
        }
        container.innerHTML = html;
      })
      .catch(console.error);
  }

  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let cookie of cookies) {
        cookie = cookie.trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  function showAddToCartFeedback(itemName) {
    const toastContainer = document.getElementById("toast-container");
    const toast = document.createElement("div");
    toast.className = "toast";
    toast.textContent = `${itemName} added to cart!`;
    toastContainer.appendChild(toast);

    setTimeout(() => toast.classList.add("show"), 50);
    setTimeout(() => {
      toast.classList.remove("show");
      setTimeout(() => toast.remove(), 300);
    }, 2500);
  }

  document.addEventListener("click", function (e) {
    if (!e.target.matches(".remove-item-btn")) return;
    e.preventDefault();

    const itemId = e.target.dataset.itemId;

    fetch(`/remove_from_cart/${itemId}/`, {
      method: "POST",
      headers: {
        "X-Requested-With": "XMLHttpRequest",
        "X-CSRFToken": getCookie("csrftoken"),
      }
    })
      .then(r => r.json())
      .then(data => {
        if (data.success) {
          updateCartDropdown();
          window.dispatchEvent(new CustomEvent('cartUpdated', {
            detail: {
              cart_count: data.cart_count,
              cart_subtotal: data.cart_subtotal
            }
          }));
        }
      })
      .catch(console.error);
  });
</script>

{% endblock %}
