{% extends 'base.html' %}
{% load static %}

{% block title %}Menu{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'meals/MenuStyle.css' %}">

<div class="menu-container">
  <div class="menu-title">
    <h1>Our Delicious Menu</h1>
    <p>Explore our wide variety of mouth-watering dishes</p>
  </div>

  <!-- Menu Controls -->
  <div class="menu-controls">
    <div class="cuisine-selector">
      <select id="cuisineFilter">
        <option value="all">All Cuisines</option>
        <option value="indian">Indian</option>
        <option value="mauritian">Mauritian</option>
        <option value="english">English</option>
        <option value="french">French</option>
        <option value="asian">Asian</option>
        <option value="thai">Thai</option>
      </select>
    </div>
  </div>

  {% if menu_by_cuisine %}
  {% for cuisine, items in menu_by_cuisine.items %}
  <div class="category-section">
    <div class="category-title">
      <h2>{{ cuisine|title}}</h2>
    </div>

    <div class="food-grid">
      {% for item in items %}
      <div class="food-item" data-cuisine="{{ item.cuisine|lower }}" data-id="{{ item.id }}" data-name="{{ item.name }}"
        data-price="{{ item.price|floatformat:0 }}">
        <div class="food-image" style="background-image: url('{{ item.display_image_url }}');">
        </div>
        <div class="food-details">
          <h3 class="food-name">{{ item.name }}</h3>
          <p class="food-description">{{ item.description }}</p>
          <div class="food-footer">
            <span class="food-price">Rs {{ item.price|floatformat:0 }}</span>
            <form action="{% url 'add_to_cart' item.id %}" method="POST" class="add-to-cart-form">
              {% csrf_token %}
              <button type="submit" class="add-btn">Add</button>
            </form>
          </div>
        </div>
      </div>
      {% empty %}
      <p>No items in this cuisines yet.</p>
      {% endfor %}
    </div>
  </div>
  {% endfor %}
  {% endif %}
</div>

<!-- Tiny client-side cuisine filter to match your data-* attributes -->
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const filter = document.getElementById("cuisineFilter");
    const items = document.querySelectorAll(".food-item");

    function applyFilter() {
      const val = filter.value;
      items.forEach(it => {
        const ok = (val === "all") || (it.dataset.cuisine === val);
        it.style.display = ok ? "" : "none";
      });
    }
    filter.addEventListener("change", applyFilter);
    applyFilter();
  });



  function addToCart(itemId) {
    fetch(`/menu/add_to_cart/${itemId}/`, {
      method: 'POST',
      headers: {
        'X-Requested-With': 'XMLHttpRequest',
        'X-CSRFToken': getCookie('csrftoken')
      }
    })
      .then(response => response.json())
      .then(data => {
        // Update cart count
        document.querySelector('.cart-count').textContent = data.cart_count;

        // Show success feedback
        showAddToCartFeedback();

        // Optional: Update cart dropdown content
        updateCartDropdown();
      })
      .catch(error => console.error('Error:', error));
  }

  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  function showAddToCartFeedback() {
    // You can add a temporary visual feedback here
    // For example, a small toast notification
    console.log('Item added to cart!');
  }

  function updateCartDropdown() {
    // Optional: Fetch and update cart dropdown content
    // This would require an additional endpoint to get cart HTML
  }


</script>
{% endblock %}