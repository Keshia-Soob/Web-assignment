{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}{% endblock %}</title>
    <link rel="stylesheet" href="{% static 'css/global.css' %}">
    <link rel="stylesheet" href="{% static 'css/cart.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>

<body>
    <header>
        <div class="header-content">
            <div class="logo">
                <a href="{% url 'home' %}"><img src="{% static 'main_page/assets/KiPouCuit_logo.png' %}"
                        alt="KiPouCuit Logo"></a>
            </div>

            <nav class="navbar">
                <li><a href="{% url 'menu' %}">KiPouCuit</a></li>
                <li><a href="{% url 'order_summary' %}">Order</a></li>
                <li><a href="{% url 'login' %}">Login</a></li>
                <li><a href="{% url 'signup' %}">Sign Up</a></li>
                <li><a href="{% url 'homecook' %}">Become a Home Cook</a></li>
            </nav>

            <div class="header-right">
                {% include 'cart.html' %}
                <!-- <div class="header-cart">
                    <div class="cart-container" style="position: relative;">
                        <div class="cart-icon" id="cartIcon" style="cursor:pointer; padding:6px; display:inline-block;">
                            <i class="fas fa-shopping-cart" aria-hidden="true"></i>
                            <span class="cart-count">{{ cart_count|default:"0" }}</span>
                        </div>

                        <div class="cart-dropdown" id="cartDropdown" aria-hidden="true" role="region"
                            aria-label="Shopping cart dropdown">
                            <div class="cart-header">Cart</div>

                            <div class="cart-items" id="cartItemsContainer">
                                {% if cart %}
                                {% for key, item in cart.items %}
                                <div class="cart-item">
                                    <div class="item-details">
                                        <div class="item-name">{{ item.name }}</div>
                                        <div class="item-quantity">Qty: {{ item.quantity }}</div>
                                        <div class="item-price">Rs {{ item.price }} x {{ item.quantity }} </div>
                                    </div>
                                    <form method="POST" action="{% url 'remove_from_cart' item_id=key %}">
                                        {% csrf_token %}
                                        <button type="submit">Remove</button>
                                    </form>
                                </div>
                                {% endfor %}
                                {% else %}
                                <div class="cart-item">
                                    <div class="item-details">
                                        <div class="item-name">Your cart is empty</div>
                                        <div class="item-quantity">Add items to see them here</div>
                                    </div>
                                </div>
                                {% endif %}
                            </div>

                            <div class="cart-footer">
                                <div class="cart-subtotal">
                                    <span>Subtotal:</span>
                                    <span id="cartSubtotal">Rs {{ cart_subtotal|default:"0" }}</span>
                                </div>
                                <div class="cart-buttons">
                                    <a href="{% url 'order_summary' %}" class="cart-button btn-checkout">Checkout</a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div> -->
                <div class="header-profile">
                    <a href=""><i class="fas fa-user"></i></a>
                </div>
            </div>
        </div>
    </header>

    <main class="content">
        {% block content %}{% endblock %}
    </main>

    <footer class="footer-container">

        <div class="center-container">

            <div class="footer-column">
                <h3>Ki Pou Cuit??</h3>
                <p>Delivering delicious food to your doorstep since 2025.</p>
            </div>

            <div class="footer-column">
                <h3>Quick Links</h3>
                <ul>
                    <li><a href="{% url 'home' %}">Home</a></li>
                    <li><a href="{% url 'menu' %}">Menu</a></li>
                    <li><a href="{% url 'order_summary' %}">Order</a></li>
                    <li><a href="{% url 'review' %}">Review</a></li>
                    <li><a href="{% url 'about' %}">About Us</a></li>
                </ul>
            </div>

            <div class="footer-column">
                <h3><a href="{% url 'contact' %}">Contact Us</a></h3>
                <ul>
                    <li><i class="fas fa-phone"></i> (123) 456-7890</li>
                    <li><i class="fas fa-envelope"></i> info@kipoucuit.com</li>
                    <li><i class="fas fa-map-marker-alt"></i> 123 Route Royale Reduit, Mauritius</li>
                </ul>
            </div>

            <div class="footer-column">
                <h3>Follow Us</h3>
                <div class="social-icons">
                    <a href="#"><i class="fab fa-facebook-f"></i></a>
                    <a href="#"><i class="fab fa-twitter"></i></a>
                    <a href="#"><i class="fab fa-instagram"></i></a>
                    <a href="#"><i class="fab fa-linkedin-in"></i></a>
                </div>
            </div>

        </div>
        <div class="footer-bottom">
            <p>2025 KiPouCuit. All Rights Reserved.</p>
        </div>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Function to check scroll position and toggle 'scrolled' class
            function checkScroll() {
                var header = document.querySelector('header');
                if (window.scrollY > 0) {
                    header.classList.add('scrolled');
                } else {
                    header.classList.remove('scrolled');
                }
            }

            checkScroll();

            window.addEventListener('scroll', checkScroll);
        });

        document.addEventListener('DOMContentLoaded', function () {
            console.log('Cart script starting...');

            const cartIcon = document.getElementById('cartIcon');
            const cartDropdown = document.getElementById('cartDropdown');
            const cartContainer = document.querySelector('.cart-container');

            if (!cartIcon) console.warn('cartIcon element NOT found');
            if (!cartDropdown) console.warn('cartDropdown element NOT found');

            // Safety: if not found, bail out
            if (!cartIcon || !cartDropdown || !cartContainer) {
                console.error('Cart toggle aborted: required DOM elements missing.');
                return;
            }

            // Ensure dropdown is hidden initially and has correct z-index
            cartDropdown.classList.remove('active');
            cartDropdown.style.zIndex = 1000; // ensure it appears above most things

            // Toggle on click
            cartIcon.addEventListener('click', function (event) {
                event.stopPropagation(); // prevent document click from closing immediately
                cartDropdown.classList.toggle('active');
                // For accessibility
                const isShown = cartDropdown.classList.contains('active');
                cartDropdown.setAttribute('aria-hidden', isShown ? 'false' : 'true');
                console.log('Cart icon clicked. Dropdown active:', isShown);
            });

            // Close when clicking outside
            document.addEventListener('click', function (event) {
                if (!cartContainer.contains(event.target)) {
                    if (cartDropdown.classList.contains('active')) {
                        cartDropdown.classList.remove('active');
                        cartDropdown.setAttribute('aria-hidden', 'true');
                        console.log('Clicked outside cart. Dropdown hidden.');
                    }
                }
            });

            // Helpful debug: show bounding rects if click seems not to register
            cartIcon.addEventListener('mouseenter', function () {
                // small visual debug in console when hovering
                const rect = cartIcon.getBoundingClientRect();
                console.log('Cart icon bounding rect:', rect);
            });

        });


        // document.addEventListener('DOMContentLoaded', function () {
        //     document.querySelectorAll('.remove-item-btn').forEach(button => {
        //         button.addEventListener('click', function () {
        //             const itemId = this.dataset.itemId;
        //             const cartItemElement = this.closest('.cart-item');

        //             fetch(`/remove_from_cart/${itemId}/`, {
        //                 method: 'POST',
        //                 headers: {
        //                     'X-CSRFToken': '{{ csrf_token }}',
        //                     'X-Requested-With': 'XMLHttpRequest'
        //                 }
        //             })
        //                 .then(res => res.json())
        //                 .then(data => {
        //                     if (data.success) {
        //                         // Remove only this item's DOM element
        //                         cartItemElement.remove();

        //                         // Update cart count and subtotal
        //                         document.querySelector('.cart-count').textContent = data.cart_count;
        //                         document.getElementById('cartSubtotal').textContent = 'Rs ' + data.cart_subtotal;

        //                         // Show empty message if last item removed
        //                         if (data.cart_count === 0) {
        //                             document.getElementById('cartItemsContainer').innerHTML = `
        //                         <div class="cart-item">
        //                             <div class="item-details">
        //                                 <div class="item-name">Your cart is empty</div>
        //                                 <div class="item-quantity">Add items to see them here</div>
        //                             </div>
        //                         </div>
        //                     `;
        //                         }
        //                     } else {
        //                         alert('Failed to remove item.');
        //                     }
        //                 })
        //                 .catch(err => console.error(err));
        //         });
        //     });
        // });
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let cookie of cookies) {
                    cookie = cookie.trim();
                    if (cookie.startsWith(name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        document.addEventListener('DOMContentLoaded', function () {
            // Delegate click to handle dynamically removed items
            document.querySelector('.cart-items').addEventListener('click', function (e) {
                if (e.target.classList.contains('remove-item-btn')) {
                    const button = e.target;
                    const itemId = button.dataset.itemId;
                    const cartItemElement = button.closest('.cart-item');

                    fetch(`/remove_from_cart/${itemId}/`, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': getCookie('csrftoken'), // CSRF token
                            'X-Requested-With': 'XMLHttpRequest'
                        }
                    })
                        .then(res => res.json())
                        .then(data => {
                            if (data.success) {
                                // Remove only this item's DOM element
                                cartItemElement.remove();

                                // Update cart count and subtotal
                                document.querySelector('.cart-count').textContent = data.cart_count;
                                document.getElementById('cartSubtotal').textContent = 'Rs ' + data.cart_subtotal;

                                // Show empty message if last item removed
                                if (data.cart_count === 0) {
                                    document.getElementById('cartItemsContainer').innerHTML = `
                            <div class="cart-item">
                                <div class="item-details">
                                    <div class="item-name">Your cart is empty</div>
                                    <div class="item-quantity">Add items to see them here</div>
                                </div>
                            </div>
                        `;
                                }
                            } else {
                                alert('Failed to remove item.');
                            }
                        })
                        .catch(err => console.error(err));
                }
            });
        });




    </script>
</body>

</html>